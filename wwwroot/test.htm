<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript" src="js/pvlib.js"></script>
<script>
  var myStatter = new statter();
  myStatter.init(10);
  myStatter._cols.push("Time");
  myStatter._cols.push("200");

  var counter = 0;

  $(document).ready(function() {
    console.log("document ready.");
    google.charts.load('current', {packages: ['corechart', 'line']});
    google.charts.setOnLoadCallback(draw);
  });

  function draw() {
    console.log("draw()");

    var data = new google.visualization.arrayToDataTable(myStatter.dump(),false);

    var options = {
      hAxis: {
        title: 'Time'
      },
      vAxis: {
        title: 'Count'
      },
      backgroundColor: '#f1f8e9'
    };

    var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
    chart.draw(data, options);

  }

  var timer, flush;

  var r1 = new Object();
  r1.ImageName = "polyverse/polyverse.io";
  r1.PerInstanceTimeout = "1000000000";

  function looper(s) {
    var url = "http://localhost:8080/infect";
    var post = $.post( url, r1 );

    post.done(function(data, status, xhr) {
      console.log("s: " + s + ", status: " + xhr.status + ", xhr.getAllResponseHeaders(): " + xhr.getAllResponseHeaders());
    });
  }

  var i1 = 0;
  function incrementHttpStatusCodes(url, obj) {
    var post = $.post( url, obj );

    post.done(function(data, status, xhr) {
      console.log("inc() = " + xhr.status);
      myStatter.inc(xhr.status,1);
    });
  }

  function flush() {
    console.log("flushing...");
    counter++;
    myStatter.gauge("Time", counter);
    myStatter.flush();

    var data = new google.visualization.arrayToDataTable(myStatter.dump(),false);
    
    var options = {
      hAxis: { 
        title: 'Time'
      },
      vAxis: { 
        title: 'Count'
      },
      backgroundColor: '#f1f8e9'
    };
    
    var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
    chart.draw(data, options);
    console.log("chart re-drawn."); 
  }

  function startTimer() {
    i1 = 0
    timer = setInterval('incrementHttpStatusCodes("http://localhost:8080/reflect", r1)', 700);
    flush = setInterval(flush, 6000);
  }

  function stopTimer() {
    clearInterval(timer);
    clearInterval(flush);
    console.log("Timer stopped.");
  }


</script>
</head>
<body>
<input type=button value="Start" onclick="startTimer();"/><input type=button value="Stop" onclick="stopTimer();"/>
<p/>
<div id="chart_div"></div>
</body>
</html>
