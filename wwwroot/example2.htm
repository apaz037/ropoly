<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script src="http://www.gstatic.com/charts/loader.js"></script>
<script src="js/polysploitWidget.js"></script>
<script src="js/statter.js"></script>
<script src="js/appInfo.js"></script>
<style>
  .widget {
    background-color: #CFCFCF;
    padding: 5px;
    margin: 5px;
    font-family: Arial;
    height: 200px;
    width: 200px;
  }
  .info {
    font-size: 12px;
  }
  input {
    width: 80px;
  }
</style>
<script>
var NUM_ROWS = 50;
var FLUSH_INTERVAL = 5000;
var REQUEST_INTERVAL = 500;
var ENDPOINT_URL = "http://localhost:8080/infect";

var CHART_OPTIONS = {
  height: 500,
  width: 1000,
  hAxis: {
    title: "Time",
  },
  vAxis: {
    //title: "Requests"
    //format: '0',
    //ticks: [0,1],
    viewWindowMode:'explicit',
    viewWindow: {
      min: 0
    }
  }
};

function systemSettingsHTML() {
  var str = "<b>URL:</b> " + ENDPOINT_URL + ", <b>Request Interval:</b> " + (REQUEST_INTERVAL / 1000) + "s" + ", <b>Flush Interval:</b> " + (FLUSH_INTERVAL / 1000) + "s";
  return str;
}

function printAppInfo(appInfo) {
  var str = "";

  str += "<div class=info>";
  str += "ID: " + appInfo.ID + "<br/>";
  str += "ImageName: " + appInfo.ImageName + "<br/>";
  str += "DesiredInstances: " + appInfo.DesiredInstances + "<br/>";
  str += "PerInstanceTimeout: " + appInfo.PerInstanceTimeout + "<br/>";
  str += "IsStateless: " + appInfo.IsStateless + "<br/>";
  str += "</div>";

  return str;
}

var myStatter = new Statter(NUM_ROWS);
for (var i = 0; i < (NUM_ROWS - 1); i++) {
  var d = new Date(Date.now() - ((NUM_ROWS - (i + 1)) * FLUSH_INTERVAL));
  myStatter.Gauge("Time",d.toLocaleTimeString());
  myStatter.Gauge("Blocked",0);
  myStatter.Flush();
}
setInterval(myFlush,FLUSH_INTERVAL);
google.charts.load('current', {packages: ['corechart', 'line']});
google.charts.setOnLoadCallback(myFlush);

var html_1 = `
  <input type=button onclick='this.parentElement.post();' value="start"></input><input type=button onclick='this.parentElement.stop();' value="stop"></input>
`;

function myFlush() {
  var d = new Date(Date.now());
  myStatter.Gauge("Time",d.toLocaleTimeString());
  myStatter.Flush();
  var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
  var data = new google.visualization.arrayToDataTable(myStatter.ToArray(),false);
  chart.draw(data, CHART_OPTIONS);
}

$(document).ready(function() {

  var systemSettings = document.getElementById("systemSettings");
  systemSettings.innerHTML = systemSettingsHTML();

  // widget 1
  var myAppInfo = new appInfo();
  myAppInfo.ID = "infectCycled";
  myAppInfo.ImageName = "polyverse/polysploit";
  myAppInfo.PerInstanceTimeout = 1000000000;
  myAppInfo.DesiredInstances = 5; 
 
  var myWidget = new polysploitWidget("widget1", myAppInfo);
  myWidget.interval = REQUEST_INTERVAL;
  myWidget.url = ENDPOINT_URL;
  myWidget.callback = function(data, status, xhr){
    myStatter.Gauge("Infections (Self-Healing)", Number(data));
  };
  myWidget.innerHTML += "Infect a container that's cycling (5 instances, 10 seconds).<p/>";
  myWidget.innerHTML += printAppInfo(myAppInfo) + "<p/>";
  myWidget.innerHTML += html_1;

  // widget 2
  var myAppInfo = new appInfo();
  myAppInfo.ID = "infectNotCycled";
  myAppInfo.ImageName = "polyverse/polysploit";
  myAppInfo.DesiredInstances = 1;
  myAppInfo.IsStateless = false;

  var myWidget = new polysploitWidget("widget2", myAppInfo);
  myWidget.interval = REQUEST_INTERVAL;
  myWidget.url = ENDPOINT_URL;
  myWidget.callback = function(data, status, xhr){
    myStatter.Gauge("Infections (Normal)", Number(data));
  };
  myWidget.innerHTML += "Infect a non-cycling container.<p/>";
  myWidget.innerHTML += printAppInfo(myAppInfo) + "<p/>";
  myWidget.innerHTML += html_1;

  // widget 3
  var myAppInfo = new appInfo();
  myAppInfo.ID = undefined;  // appinfo doesn't return route if this is undefined.
  myAppInfo.ImageName = "polyverse/polysploit";
  myAppInfo.PerInstanceTimeout = 1000000000;
  myAppInfo.DesiredInstances = 5; 

  var myWidget = new polysploitWidget("widget3", myAppInfo);
  myWidget.interval = REQUEST_INTERVAL;
  myWidget.url = ENDPOINT_URL;
  myWidget.callback = function(data, status, xhr){
    if (status === "error") {
     myStatter.Inc("Blocked",1);
    } else {
     myStatter.Inc("Non-Whitelisted Request - " + status, 1);
    }
  };
  myWidget.innerHTML += "<b>Blocked</b> scenario<p/>";
  myWidget.innerHTML += printAppInfo(myAppInfo) + "<p/>";
  myWidget.innerHTML += html_1;

  // widget 4
  var myAppInfo = new appInfo();
  myAppInfo.ID = "goodRequest";
  myAppInfo.ImageName = "polyverse/polysploit";
  myAppInfo.PerInstanceTimeout = 1000000000;
  myAppInfo.DesiredInstances = 5;

  var myWidget = new polysploitWidget("widget4", myAppInfo);
  myWidget.interval = REQUEST_INTERVAL;
  myWidget.url = ENDPOINT_URL;
  myWidget.callback = function(data, status, xhr){
    myStatter.Inc("Whitelisted Request - " + status, 1);
  };
  myWidget.innerHTML += "Each request includes a pattern that is explicitly whitelisted by the Polyverse router.<p/>"
  myWidget.innerHTML += printAppInfo(myAppInfo) + "<p/>";
  myWidget.innerHTML += html_1;
});
</script>
</head>
<body>
<div id=systemSettings></div>
<table>
<tr>
  <td><div id="widget3" class="widget"></div></td>
  <td><div id="widget2" class="widget"></div></td>
  <td><div id="widget1" class="widget"></div></td>
  <td><div id="widget4" class="widget"></div></td>
</tr>
</table>
<div id="chart_div"></div>
</body>
</html>
